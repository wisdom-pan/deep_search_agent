services:
  # Neo4j 图数据库服务
  neo4j:
    image: neo4j:5.22.0
    container_name: graphrag-neo4j
    ports:
      - "7474:7474"  # Neo4j Web UI
      - "7687:7687"  # Neo4j Bolt协议
    environment:
      NEO4J_AUTH: "neo4j/12345678"
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*,gds.*"
      NEO4J_dbms_memory_heap_initial__size: "2G"
      NEO4J_dbms_memory_heap_max__size: "4G"
      NEO4J_dbms_memory_pagecache_size: "2G"
      NEO4J_apoc_trigger_enabled: "true"
      NEO4J_server_memory_pagecache_size: "2G"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "12345678", "RETURN 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s


  # 知识图谱初始化服务
  init-kg:
    build:
      context: .
      dockerfile: Dockerfile.init
    container_name: graphrag-init-kg
    mem_limit: 12g
    mem_reservation: 8g
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_LLM_MODEL=${OPENAI_LLM_MODEL}
      - OPENAI_EMBEDDINGS_MODEL=${OPENAI_EMBEDDINGS_MODEL}
      - NEO4J_URI=neo4j://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=12345678
      - GRAPH_CONFLICT_STRATEGY=merge
      - GRAPH_COMMUNITY_ALGORITHM=leiden
    volumes:
      - ./files:/app/files
      - ./graphrag_agent/config:/app/graphrag_agent/config
      - ./cache:/app/cache
    depends_on:
      neo4j:
        condition: service_healthy
    restart: "no"
    command: >
      sh -c "
        echo '等待Neo4j完全启动...' &&
        sleep 10 &&
        python -m graphrag_agent.integrations.build.main
      "

  # 后端 API 服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: graphrag-backend
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_LLM_MODEL=${OPENAI_LLM_MODEL}
      - OPENAI_EMBEDDINGS_MODEL=${OPENAI_EMBEDDINGS_MODEL}
      - NEO4J_URI=neo4j://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=12345678
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8000
    volumes:
      - ./graphrag_agent/config:/app/graphrag_agent/config
      - ./cache:/app/cache
    depends_on:
      init-kg:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # 前端 Streamlit 服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: graphrag-frontend
    ports:
      - "8501:8501"
    environment:
      - FRONTEND_API_URL=http://backend:8000
      - FRONTEND_DEFAULT_AGENT=naive_rag_agent
      - FRONTEND_USE_DEEPER_TOOL=true
      - FRONTEND_USE_STREAM=true
    volumes:
      - ./frontend:/app/frontend
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

# 数据卷定义
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  # oneapi_data:  # 仅在启用 one-api 时需要
  #   driver: local

# 网络配置
networks:
  default:
    name: graphrag-network
    driver: bridge